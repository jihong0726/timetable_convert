<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>班表转换器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, SF Pro Text, Segoe UI, system-ui, sans-serif;
    }

    body {
      min-height: 100vh;
      background: #050816;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1180px;
      height: 90vh;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 24px;
      box-shadow: 0 28px 70px rgba(0,0,0,0.75);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      margin-bottom: 10px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
      line-height: 1.4;
    }

    .app-body {
      flex: 1;
      margin-top: 4px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      min-height: 0;
    }

    .panel {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      margin-bottom: 8px;
      font-size: 13px;
    }

    .input-area,
    .output-area {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: #020617;
      padding: 8px;
      width: 100%;
      font-size: 13px;
      color: #e5e7eb;
      outline: none;
      line-height: 1.45;
      overflow: auto;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 6px;
      color: #e5e7eb;
      background: rgba(31,41,55,0.9);
      border: 1px solid rgba(75,85,99,0.9);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #f9fafb;
    }

    .status { font-size: 11px; margin-top: 6px; min-height: 16px; }
    .ok { color: #4ade80; }
    .error { color: #f87171; }

    .stats {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      padding-top: 6px;
      border-top: 1px solid rgba(55,65,81,0.7);
    }

    @media(max-width:960px){
      .app-body { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="app-header">
    <div class="title">班表转换器</div>
    <div class="subtitle">
      操作介绍：直接复制一个月的日期以及星期几，再复制时间也可以使用。<br>
      支持自动展开班次、统计、下载 TXT、设备间 GitHub 文件共享。
    </div>
  </div>

  <div class="app-body">

    <!-- 输入 -->
    <div class="panel">
      <div class="panel-header">1. 粘贴飞书复制的排班内容</div>

      <textarea id="inputRaw" class="input-area"
        placeholder="例如：&#10;12月1日 12月2日 12月3日...&#10;星期一 星期二 星期三...&#10;9:00 9:00 OFF ..."
      ></textarea>

      <div style="margin-top:8px;">
        <input id="titleInput" type="text" placeholder="标题名称（如 积宏）"
          style="border-radius:999px;padding:4px 10px;border:1px solid #555;background:#020617;color:#e5e7eb;font-size:12px;">
        <select id="yearSelect"
          style="border-radius:999px;padding:4px 10px;border:1px solid #555;background:#020617;color:#e5e7eb;">
        </select>
        <select id="monthSelect"
          style="border-radius:999px;padding:4px 10px;border:1px solid #555;background:#020617;color:#e5e7eb;">
        </select>
      </div>

      <div style="margin-top:8px;">
        <button class="btn" id="btnClear">清空</button>
        <button class="btn btn-primary" id="btnParse">生成时间表</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <!-- 输出 -->
    <div class="panel">
      <div class="panel-header">2. 生成的时间表（可复制 / 下载 TXT）</div>

      <textarea id="outputText" class="output-area"
        placeholder="会在这里自动生成内容..."
      ></textarea>

      <div style="margin-top:8px;">
        <button class="btn" id="btnCopy">复制</button>
        <button class="btn" id="btnDownload">下载 TXT</button>
      </div>

      <div class="stats" id="stats"></div>
    </div>

  </div>
</div>

<script>
const STORAGE_KEY = "schedule_converter_v1";

const inputRaw = document.getElementById("inputRaw");
const outputText = document.getElementById("outputText");
const statusEl = document.getElementById("status");
const statsEl = document.getElementById("stats");

const titleInput = document.getElementById("titleInput");
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");

function initYM(){
  const y = new Date().getFullYear();
  for(let i=y-1;i<=y+3;i++){
    const o=document.createElement("option");
    o.value=i; o.textContent=i+"年";
    if(i===y) o.selected=true;
    yearSelect.appendChild(o);
  }
  const m=new Date().getMonth()+1;
  for(let i=1;i<=12;i++){
    const o=document.createElement("option");
    o.value=i;
    o.textContent=i+"月";
    if(i===m) o.selected=true;
    monthSelect.appendChild(o);
  }
}
initYM();

// ---------------- 班次展开 +9 小时 ----------------
function formatShift(s){
  s=s.trim();
  const m=s.match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return s;

  const h=parseInt(m[1],10);
  const mm=m[2];
  const end=(h+9)%24;
  const endDisplay=(h+9)>=24?24:end;

  const pad=n=>n<10?"0"+n:n;
  return `${pad(h)}:${mm} - ${pad(endDisplay)}:${mm}`;
}

// ---------------- 班次分类统计 ----------------
function classify(raw, stats){
  const s=raw.trim().toUpperCase();
  if(!s) return;

  if(s==="AL"){
    stats.nianjia++; return;
  }
  if(s==="OFF"||s==="REST"){
    stats.rest++; return;
  }

  const m=s.match(/^(\d{1,2}):(\d{2})$/);
  if(m){
    const h=parseInt(m[1],10);
    const mm=parseInt(m[2],10);
    if(mm===0){
      if(h===8){stats.zaozao++;return;}
      if(h===9){stats.bai++;return;}
      if(h===12){stats.zhong++;return;}
      if(h===15){stats.wan++;return;}
      if(h===16){stats.wanwan++;return;}
      if(h===0||h===24){stats.ye++;return;}
    }
  }
}

// ---------------- 主解析逻辑 ----------------
function parseSchedule(raw){
  const lines=raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) throw new Error("请先粘贴排班内容");

  const rows=lines.map(r=>r.split(/\s+/));
  const dateRe=/(\d{1,2})月(\d{1,2})日/;
  const weekRe=/星期[一二三四五六日天]/;

  let startCol=null;
  rows.forEach(r=>{
    r.forEach((c,i)=>{
      if(dateRe.test(c)){
        if(startCol===null||i<startCol) startCol=i;
      }
    });
  });

  if(startCol===null) throw new Error("未识别到日期行");

  const colCount=Math.max(...rows.map(r=>r.length));
  const dates=new Array(colCount).fill("");
  const weeks=new Array(colCount).fill("");

  rows.forEach(r=>{
    for(let i=startCol;i<r.length;i++){
      const c=r[i];
      if(dateRe.test(c)) dates[i]=c;
      if(weekRe.test(c)) weeks[i]=c;
    }
  });

  const lastRow=rows[rows.length-1];

  const stats={
    zaozao:0, bai:0, zhong:0, wan:0, wanwan:0, ye:0,
    nianjia:0, rest:0, chuqin:0
  };

  const res=[];
  const monthHint=monthSelect.value;

  for(let i=startCol;i<lastRow.length;i++){
    const rawShift=lastRow[i]||"";
    classify(rawShift, stats);

    let date=dates[i];
    if(!date){
      const day=i-startCol+1;
      date=`${monthHint}月${day}日`;
    }

    const week=weeks[i]?"（"+weeks[i]+"）":"";
    const shift=formatShift(rawShift);

    res.push(`${date}${week}：${shift}`);
  }

  stats.chuqin=stats.zaozao+stats.bai+stats.zhong+stats.wan+stats.wanwan+stats.ye;

  return {text:res.join("\n"), stats};
}

function updateStats(stats){
  statsEl.innerHTML = `
    班次统计（不会写入文本）：<br>
    早早：${stats.zaozao}　白：${stats.bai}　中：${stats.zhong}　
    晚：${stats.wan}　晚晚：${stats.wanwan}　夜：${stats.ye}<br>
    年假：${stats.nianjia}　休息：${stats.rest}　出勤：${stats.chuqin}
  `;
}

document.getElementById("btnParse").onclick=function(){
  try{
    const raw=inputRaw.value;
    const {text, stats}=parseSchedule(raw);
    const title=(titleInput.value.trim()||"我的")+"的 "+
      yearSelect.value+" 年 "+monthSelect.value+" 月时间表";

    outputText.value = title+"\n"+text;
    updateStats(stats);
    statusEl.innerHTML='<span class="ok">已生成班表</span>';
  }catch(e){
    statusEl.innerHTML='<span class="error">'+e.message+'</span>';
  }
};

document.getElementById("btnCopy").onclick=async function(){
  try{
    await navigator.clipboard.writeText(outputText.value);
    statusEl.innerHTML='<span class="ok">已复制</span>';
  }catch(e){
    statusEl.innerHTML='<span class="error">复制失败</span>';
  }
};

document.getElementById("btnDownload").onclick=function(){
  const text=outputText.value;
  if(!text) return;

  const name=titleInput.value.trim()||"schedule";
  const y=yearSelect.value;
  const m=monthSelect.value.padStart(2,"0");
  const filename=`${name}_${y}-${m}_班表.txt`;

  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  a.click();
  URL.revokeObjectURL(url);

  statusEl.innerHTML='<span class="ok">已下载 TXT</span>';
};

document.getElementById("btnClear").onclick=function(){
  inputRaw.value="";
  outputText.value="";
  statsEl.innerHTML="";
  statusEl.innerHTML='<span class="ok">已清空</span>';
};
</script>

</body>
</html>
