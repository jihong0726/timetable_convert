<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>班表转换器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, SF Pro Text, Segoe UI, system-ui, sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #000000 100%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 1180px;
      height: 92vh;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
      border-radius: 24px;
      box-shadow: 0 28px 70px rgba(0,0,0,0.80);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .app-header {
      margin-bottom: 8px;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      line-height: 1.5;
    }
    .tabs {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.9);
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.12s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #f9fafb;
      border-color: rgba(129,140,248,0.9);
      box-shadow: 0 6px 18px rgba(37,99,235,0.8);
    }
    .app-body {
      flex: 1;
      margin-top: 10px;
      min-height: 0;
      position: relative;
    }
    .mode {
      position: absolute;
      inset: 0;
      display: none;
    }
    .mode.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      min-height: 0;
    }
    .panel {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.15), rgba(15,23,42,0.98));
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel-header {
      margin-bottom: 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #e5e7eb;
    }
    .panel-header span.right {
      font-size: 11px;
      color: #9ca3af;
    }
    .input-area,
    .output-area {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: #020617;
      padding: 8px;
      width: 100%;
      font-size: 13px;
      color: #e5e7eb;
      outline: none;
      line-height: 1.45;
      overflow: auto;
    }
    .input-area::placeholder,
    .output-area::placeholder {
      color: #4b5563;
    }
    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 6px;
      color: #e5e7eb;
      background: rgba(31,41,55,0.95);
      border: 1px solid rgba(75,85,99,0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s, box-shadow 0.12s, background 0.12s;
    }
    .btn:hover {
      background: rgba(55,65,81,0.95);
      box-shadow: 0 4px 14px rgba(15,23,42,0.8);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 6px rgba(15,23,42,0.9);
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border: 1px solid rgba(129,140,248,0.9);
      box-shadow: 0 8px 24px rgba(37,99,235,0.85);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8, #6d28d9);
    }
    .status {
      font-size: 11px;
      margin-top: 6px;
      min-height: 16px;
    }
    .ok { color: #4ade80; }
    .error { color: #f97373; }
    .field-line {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .field-line input,
    .field-line select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .stats {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      padding-top: 6px;
      border-top: 1px solid rgba(55,65,81,0.7);
      line-height: 1.8;
    }
    @media(max-width:960px){
      .app-body { height: auto; }
      .mode.active { grid-template-columns: 1fr; position: static; }
      .mode { position: static; }
      .app { height: auto; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-header">
    <div class="title">班表转换器</div>
    <div class="subtitle">
      直接从飞书复制一整个月的日期和星期，再复制对应的上班时间，粘贴到左侧即可一键生成文字版班表和统计结果。<br>
      模式支持：单人班表 · 班表对比 · 班次查人 · 按日期查代码 · 整月代码统计。
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-mode="single">单人班表</button>
      <button class="tab-btn" data-mode="compare">班表对比</button>
      <button class="tab-btn" data-mode="shiftpeople">班次查人</button>
      <button class="tab-btn" data-mode="codebyday">按日期查代码</button>
      <button class="tab-btn" data-mode="codestats">整月代码统计</button>
    </div>
  </div>

  <div class="app-body">
    <!-- 模式 1：单人班表 -->
    <div class="mode active" id="mode-single">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴飞书排班内容</span>
          <span class="right">示例：日期行 + 星期行 + 时间行</span>
        </div>
        <textarea id="inputRaw1" class="input-area"
          placeholder="例如：&#10;12月1日 12月2日 12月3日...&#10;星期一 星期二 星期三...&#10;9:00 9:00 OFF ..."
        ></textarea>
        <div class="field-line">
          <input id="titleInput1" type="text" placeholder="标题名称（如 积宏）">
          <select id="yearSelect1"></select>
          <select id="monthSelect1"></select>
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnClear1">清空</button>
          <button class="btn btn-primary" id="btnParse1">生成时间表</button>
        </div>
        <div class="status" id="status1"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 结果预览</span>
          <span class="right">可复制 / 下载 TXT / 导出 iOS 日历</span>
        </div>
        <textarea id="outputText1" class="output-area"
          placeholder="会在这里自动生成文字版班表..."
        ></textarea>
        <div style="margin-top:8px;">
          <button class="btn" id="btnCopy1">复制</button>
          <button class="btn" id="btnDownloadTxt1">下载 TXT</button>
          <button class="btn" id="btnDownloadICS1">导出日历 (ICS)</button>
        </div>
        <div class="stats" id="stats1"></div>
      </div>
    </div>

    <!-- 模式 2：班表对比 -->
    <div class="mode" id="mode-compare">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴两个人的飞书排班</span>
          <span class="right">格式同单人班表</span>
        </div>
        <textarea id="inputA" class="input-area" placeholder="A 的排班（日期行 + 星期行 + A 的时间行）"></textarea>
        <div class="field-line">
          <input id="nameA" type="text" placeholder="A 的名字（如 积宏）">
        </div>
        <div style="height:8px;"></div>
        <textarea id="inputB" class="input-area" placeholder="B 的排班（日期行 + 星期行 + B 的时间行）"></textarea>
        <div class="field-line">
          <input id="nameB" type="text" placeholder="B 的名字（如 Dora）">
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnClear2">清空</button>
          <button class="btn btn-primary" id="btnCompare">生成对比</button>
        </div>
        <div class="status" id="status2"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 两人的共同上班时间</span>
          <span class="right">显示同一天同班次的日期</span>
        </div>
        <textarea id="outputCompare" class="output-area"
          placeholder="这里会显示：有哪些天两个人是同班次上班，以及整体统计..."
        ></textarea>
      </div>
    </div>

    <!-- 模式 3：班次查人 -->
    <div class="mode" id="mode-shiftpeople">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴直列的人员 + 当天时间</span>
          <span class="right">建议：姓名列表 + 某一天的时间列</span>
        </div>
        <textarea id="inputRaw3" class="input-area"
          placeholder="例如：&#10;（上面）很多行姓名，每行一个人&#10;...&#10;12月4日&#10;星期四&#10;9:00&#10;15:00&#10;OFF&#10;9:00&#10;...&#10;（人数顺序与时间顺序一一对应）"
        ></textarea>
        <div class="field-line">
          <input id="dateOverride" type="text" placeholder="可选：手动填 日期 如 12月4日">
          <input id="weekOverride" type="text" placeholder="可选：手动填 星期 如 星期四">
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnClear3">清空</button>
          <button class="btn btn-primary" id="btnShiftPeople">生成班次人员列表</button>
        </div>
        <div class="status" id="status3"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 各班次对应的人员</span>
          <span class="right">按班次分组显示谁在上班</span>
        </div>
        <textarea id="outputText3" class="output-area"
          placeholder="这里会显示：白班有哪些人、晚班有哪些人、夜班有哪些人..."
        ></textarea>
        <div class="stats" id="stats3"></div>
      </div>
    </div>

    <!-- 模式 4：按日期查代码 -->
    <div class="mode" id="mode-codebyday">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴整页排班表</span>
          <span class="right">姓名 + 当月所有日期列</span>
        </div>
        <textarea id="inputRaw4" class="input-area"
          placeholder="从飞书 / 表格复制整页内容：上方是日期行、星期行，下面是每个人每天的代码或时间（9:00 / MC / OFF / REST ...）"
        ></textarea>
        <div class="field-line">
          <button class="btn" id="btnParse4">解析表格</button>
          <button class="btn" id="btnClear4">清空</button>
        </div>
        <div class="field-line">
          <select id="daySelect4">
            <option value="">请选择日期</option>
          </select>
          <select id="codeSelect4">
            <option value="">请选择代码 / 班次</option>
          </select>
          <button class="btn btn-primary" id="btnQuery4">查询</button>
        </div>
        <div class="status" id="status4"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 查询结果</span>
          <span class="right">指定日期 + 代码 → 谁是这个班次 / 代码</span>
        </div>
        <textarea id="outputText4" class="output-area"
          placeholder="解析后，可选择某一天 + 某个代码/时间（如 9:00、MC、OFF），这里会显示当天该代码对应的所有人员名单。"
        ></textarea>
      </div>
    </div>

    <!-- 模式 5：整月代码统计 -->
    <div class="mode" id="mode-codestats">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴整页排班表</span>
          <span class="right">例如：想统计整月 MC 次数</span>
        </div>
        <textarea id="inputRaw5" class="input-area"
          placeholder="同上：姓名 + 日期列。整页复制后贴进来，例如要统计整个月 MC 出现次数。"
        ></textarea>
        <div class="field-line">
          <input id="codeInput5" type="text" placeholder="统计的代码（默认 MC）">
        </div>
        <div class="field-line">
          <button class="btn" id="btnClear5">清空</button>
          <button class="btn btn-primary" id="btnStats5">统计代码次数</button>
        </div>
        <div class="status" id="status5"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 统计结果</span>
          <span class="right">按人统计该代码在整月出现次数</span>
        </div>
        <textarea id="outputText5" class="output-area"
          placeholder="这里会显示：每个人 MC（或其它代码）出现了多少次，会按次数从高到低排序。"
        ></textarea>
      </div>
    </div>

  </div>
</div>

<script>
  const pad = n => (n < 10 ? "0" + n : "" + n);

  const TYPE_NAME = {
    ZAOZAO: "早早班",
    BAI: "白班",
    ZHONG: "中班",
    WAN: "晚班",
    WANWAN: "晚晚班",
    YE: "夜班",
    NIANJIA: "年假",
    REST: "休息"
  };

  function splitRow(line) {
    return line.trim().split(/\s+/).filter(Boolean);
  }
  function isWorkType(key) {
    return ["ZAOZAO","BAI","ZHONG","WAN","WANWAN","YE"].includes(key);
  }

  // 班次分类
  function classifyShift(rawShift, stats) {
    const s = rawShift.trim().toUpperCase();
    if (!s) return null;

    if (s === "AL") {
      stats.nianjia++;
      return "NIANJIA";
    }
    if (s === "OFF" || s === "REST") {
      stats.rest++;
      return "REST";
    }

    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (m) {
      const h = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      if (mm === 0) {
        if (h === 8)  { stats.zaozao++; return "ZAOZAO"; }
        if (h === 9)  { stats.bai++;    return "BAI";    }
        if (h === 12) { stats.zhong++;  return "ZHONG";  }
        if (h === 15) { stats.wan++;    return "WAN";    }
        if (h === 16) { stats.wanwan++; return "WANWAN"; }
        if (h === 0 || h === 24) { stats.ye++; return "YE"; }
      }
    }
    return null;
  }

  // 9:00 -> 09:00 - 18:00
  function formatShift(rawShift) {
    const s = rawShift.trim();
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return s;

    const startHour = parseInt(m[1], 10);
    const minute = parseInt(m[2], 10);
    const added = startHour + 9;
    const endHour24 = added % 24;
    const displayEndHour = (added >= 24 && endHour24 === 0) ? 24 : endHour24;

    return `${pad(startHour)}:${pad(minute)} - ${pad(displayEndHour)}:${pad(minute)}`;
  }

  // 解析「一行日期 + 一行星期 + 一行时间」的简表（单人、对比）
  function parseFeishuSchedule(raw, monthHint) {
    const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) throw new Error("请先粘贴排班内容");

    const rows = lines.map(splitRow);
    const dateRe = /(\d{1,2})\s*月\s*(\d{1,2})\s*日/;
    const weekRe = /星期[一二三四五六日天]/;

    let startCol = null;
    rows.forEach(r => {
      r.forEach((c, i) => {
        if (dateRe.test(c)) {
          if (startCol === null || i < startCol) startCol = i;
        }
      });
    });
    if (startCol === null) throw new Error("未识别到日期行（例如 12月1日）");

    const colCount = Math.max(...rows.map(r => r.length));
    const dates = new Array(colCount).fill("");
    const weeks = new Array(colCount).fill("");
    const days  = new Array(colCount).fill(null);

    rows.forEach(r => {
      for (let i = startCol; i < r.length; i++) {
        const c = r[i];
        const dm = c.match(dateRe);
        if (dm) {
          dates[i] = c;
          const dayNum = parseInt(dm[2], 10);
          if (!isNaN(dayNum)) days[i] = dayNum;
        }
        if (/星期[一二三四五六日天]/.test(c)) weeks[i] = c;
      }
    });

    const lastRow = rows[rows.length - 1];
    const stats = {
      zaozao:0, bai:0, zhong:0, wan:0, wanwan:0, ye:0,
      nianjia:0, rest:0, chuqin:0
    };
    const entries = [];
    const events = [];

    for (let i = startCol; i < lastRow.length; i++) {
      const rawShift = (lastRow[i] || "").trim();
      if (!rawShift) continue;
      const typeKey = classifyShift(rawShift, stats);

      let dateStr = dates[i];
      let dayNum = days[i];
      if (!dateStr) {
        const dayIndex = i - startCol + 1;
        if (monthHint) {
          dateStr = `${monthHint}月${dayIndex}日`;
          dayNum = dayIndex;
        } else {
          dateStr = `第${dayIndex}天`;
        }
      }
      const weekStr = weeks[i] || "";
      const displayShift = formatShift(rawShift);

      entries.push({ dateStr, weekStr, dayNum, rawShift, typeKey, displayShift });

      const timeMatch = rawShift.match(/^(\d{1,2}):(\d{2})$/);
      if (timeMatch && isWorkType(typeKey) && monthHint && dayNum) {
        const startHour = parseInt(timeMatch[1], 10);
        const startMinute = parseInt(timeMatch[2], 10);
        const added = startHour + 9;
        const endHour24 = added % 24;
        const endHour = (added >= 24 && endHour24 === 0) ? 24 : endHour24;
        const endMinute = startMinute;
        events.push({ day: dayNum, startHour, startMinute, endHour, endMinute, typeKey });
      }
    }

    stats.chuqin =
      stats.zaozao + stats.bai + stats.zhong +
      stats.wan + stats.wanwan + stats.ye;

    return { entries, stats, events };
  }

  // 解析「整页排班表」（多行：姓名 + 各天代码）
  function parseFullSheet(raw) {
    const lines = raw.split(/\r?\n/).map(l => l.replace(/\s+$/,"")).filter(l => l !== "");
    if (!lines.length) throw new Error("请先粘贴整页排班内容");

    const rows = lines.map(line => line.split(/\t+/).map(c => c.trim()));
    const dateRe = /(\d{1,2})\s*月\s*(\d{1,2})\s*日/;
    const weekRe = /星期[一二三四五六日天]/;

    let dateRowIndex = -1;
    let startCol = null;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const indices = [];
      row.forEach((c, idx) => {
        if (dateRe.test(c)) indices.push(idx);
      });
      if (indices.length >= 3) {
        dateRowIndex = i;
        startCol = Math.min(...indices);
        break;
      }
    }
    if (dateRowIndex === -1) throw new Error("整页表格中未识别到日期行（例如 12月1日 12月2日 ...）");

    let weekRowIndex = -1;
    for (let i = dateRowIndex + 1; i < rows.length; i++) {
      const row = rows[i];
      if (row.some(c => weekRe.test(c))) {
        weekRowIndex = i;
        break;
      }
    }
    const dateRow = rows[dateRowIndex];
    const days = [];
    const dayToLabel = {};
    for (let col = startCol; col < dateRow.length; col++) {
      const c = dateRow[col];
      const m = c && c.match(dateRe);
      let dayNum;
      if (m) {
        dayNum = parseInt(m[2], 10);
      } else {
        dayNum = col - startCol + 1;
      }
      const label = c || `本月第${dayNum}天`;
      days.push({ colIndex: col, day: dayNum, label });
      dayToLabel[dayNum] = label;
    }

    const staffRows = [];
    for (let i = (weekRowIndex !== -1 ? weekRowIndex + 1 : dateRowIndex + 1); i < rows.length; i++) {
      const row = rows[i];
      let hasValue = false;
      for (const d of days) {
        const v = row[d.colIndex];
        if (v && v.trim() !== "") {
          hasValue = true;
          break;
        }
      }
      if (!hasValue) continue;

      const nameParts = row.slice(0, startCol).map(c => c.trim()).filter(Boolean);
      const name = nameParts.join(" ").trim();
      if (!name || /^[0-9]+$/.test(name)) continue;

      const codes = {};
      for (const d of days) {
        const v = row[d.colIndex] || "";
        if (v && v.trim() !== "") {
          codes[d.day] = v.trim();
        }
      }
      staffRows.push({ name, codes });
    }

    if (!staffRows.length) throw new Error("未识别到有效的姓名行，请确认表格中包含姓名 + 各天代码。");
    return { days, dayToLabel, staffRows };
  }

  // ICS 构造
  function buildICS(events, year, month, name) {
    const now = new Date();
    const dtstamp =
      now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) +
      "T" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());

    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//ScheduleConverter//CN");

    events.forEach((e, idx) => {
      const y = parseInt(year, 10);
      const m = parseInt(month, 10);
      const d = e.day;

      const dtstart = `${y}${pad(m)}${pad(d)}T${pad(e.startHour)}${pad(e.startMinute)}00`;
      const endHour = e.endHour === 24 ? 23 : e.endHour;
      const endMinute = e.endHour === 24 ? 59 : e.endMinute;
      const dtend = `${y}${pad(m)}${pad(d)}T${pad(endHour)}${pad(endMinute)}00`;

      const label = TYPE_NAME[e.typeKey] || "上班";
      const summary = label;
      const uid = `${y}${pad(m)}${pad(d)}-${pad(e.startHour)}${pad(e.startMinute)}-${idx}@schedule.local`;

      lines.push("BEGIN:VEVENT");
      lines.push("UID:" + uid);
      lines.push("DTSTAMP:" + dtstamp);
      lines.push("DTSTART:" + dtstart);
      lines.push("DTEND:" + dtend);
      lines.push("SUMMARY:" + summary);
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");
    return lines.join("\r\n");
  }

  // Tab 切换
  const tabBtns = document.querySelectorAll(".tab-btn");
  const modes = {
    single: document.getElementById("mode-single"),
    compare: document.getElementById("mode-compare"),
    shiftpeople: document.getElementById("mode-shiftpeople"),
    codebyday: document.getElementById("mode-codebyday"),
    codestats: document.getElementById("mode-codestats")
  };
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const mode = btn.dataset.mode;
      tabBtns.forEach(b => b.classList.toggle("active", b === btn));
      Object.keys(modes).forEach(key => {
        modes[key].classList.toggle("active", key === mode);
      });
    });
  });

  // ---------- 模式 1：单人 ----------
  const inputRaw1 = document.getElementById("inputRaw1");
  const outputText1 = document.getElementById("outputText1");
  const titleInput1 = document.getElementById("titleInput1");
  const yearSelect1 = document.getElementById("yearSelect1");
  const monthSelect1 = document.getElementById("monthSelect1");
  const status1 = document.getElementById("status1");
  const stats1 = document.getElementById("stats1");
  const btnParse1 = document.getElementById("btnParse1");
  const btnCopy1  = document.getElementById("btnCopy1");
  const btnClear1 = document.getElementById("btnClear1");
  const btnDownloadTxt1 = document.getElementById("btnDownloadTxt1");
  const btnDownloadICS1 = document.getElementById("btnDownloadICS1");
  let lastEvents1 = [];

  function setStatus1(text, type) {
    if (!text) { status1.innerHTML = ""; return; }
    const cls = type === "ok" ? "ok" : type === "error" ? "error" : "";
    status1.innerHTML = `<span class="${cls}">${text}</span>`;
  }
  (function initYM1(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth() + 1;
    for (let i = y - 1; i <= y + 3; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i + "年";
      if (i === y) o.selected = true;
      yearSelect1.appendChild(o);
    }
    for (let i = 1; i <= 12; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i + "月";
      if (i === m) o.selected = true;
      monthSelect1.appendChild(o);
    }
  })();

  function updateStatsBox(stats, el) {
    el.innerHTML =
      `班次统计（仅展示，不会写入文本）：<br>` +
      `早早：${stats.zaozao}　白：${stats.bai}　中：${stats.zhong}　晚：${stats.wan}　晚晚：${stats.wanwan}　夜：${stats.ye}<br>` +
      `年假：${stats.nianjia}　休息：${stats.rest}　出勤：${stats.chuqin}`;
  }

  btnParse1.onclick = () => {
    try {
      const raw = inputRaw1.value;
      const month = parseInt(monthSelect1.value, 10) || null;
      const { entries, stats, events } = parseFeishuSchedule(raw, month);
      lastEvents1 = events;

      const name  = titleInput1.value.trim() || "我的";
      const year  = yearSelect1.value;
      const monthText = monthSelect1.value;
      const titleLine = `${name}的 ${year} 年 ${monthText} 月时间表`;

      const lines = entries.map(e => {
        const w = e.weekStr ? `（${e.weekStr}）` : "";
        return `${e.dateStr}${w}：${e.displayShift}`;
      });

      outputText1.value = titleLine + "\n" + lines.join("\n");
      updateStatsBox(stats, stats1);
      setStatus1("已生成班表与统计", "ok");
    } catch (e) {
      lastEvents1 = [];
      stats1.innerHTML = "";
      setStatus1(e.message || "解析失败", "error");
    }
  };
  btnCopy1.onclick = async () => {
    try {
      await navigator.clipboard.writeText(outputText1.value);
      setStatus1("已复制到剪贴板", "ok");
    } catch {
      setStatus1("复制失败，请手动选择复制", "error");
    }
  };
  btnDownloadTxt1.onclick = () => {
    const text = outputText1.value.trim();
    if (!text) { setStatus1("当前没有可下载的内容", "error"); return; }
    const name = (titleInput1.value.trim() || "schedule").replace(/[\\/:*?"<>|]/g,"_");
    const y = yearSelect1.value;
    const m = monthSelect1.value.toString().padStart(2,"0");
    const filename = `${name}_${y}-${m}_班表.txt`;
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus1("已下载 TXT", "ok");
  };
  btnDownloadICS1.onclick = () => {
    if (!lastEvents1.length) { setStatus1("当前没有可导出的班次（请先生成班表）", "error"); return; }
    const y = yearSelect1.value;
    const m = monthSelect1.value;
    const name = titleInput1.value.trim() || "我的";
    const ics = buildICS(lastEvents1, y, m, name);
    const safeName = name.replace(/[\\/:*?"<>|]/g,"_");
    const mm = m.toString().padStart(2,"0");
    const filename = `${safeName}_${y}-${mm}_班表.ics`;
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus1("已导出 iOS 日历文件（ICS）", "ok");
  };
  btnClear1.onclick = () => {
    inputRaw1.value = "";
    outputText1.value = "";
    stats1.innerHTML = "";
    lastEvents1 = [];
    setStatus1("已清空", "ok");
  };

  // ---------- 模式 2：对比 ----------
  const inputA = document.getElementById("inputA");
  const inputB = document.getElementById("inputB");
  const nameAEl = document.getElementById("nameA");
  const nameBEl = document.getElementById("nameB");
  const status2 = document.getElementById("status2");
  const outputCompare = document.getElementById("outputCompare");
  const btnClear2 = document.getElementById("btnClear2");
  const btnCompare = document.getElementById("btnCompare");
  function setStatus2(text,type){ if(!text){status2.innerHTML="";return;} const cls=type==="ok"?"ok":type==="error"?"error":""; status2.innerHTML=`<span class="${cls}">${text}</span>`;}
  btnCompare.onclick = () => {
    try{
      const rawA = inputA.value, rawB = inputB.value;
      if(!rawA.trim() || !rawB.trim()) throw new Error("请分别粘贴 A 和 B 的排班内容");
      const month = parseInt(monthSelect1.value,10) || null;
      const {entries:entriesA} = parseFeishuSchedule(rawA, month);
      const {entries:entriesB} = parseFeishuSchedule(rawB, month);
      const mapA=new Map(), mapB=new Map();
      entriesA.forEach(e=>{ if(e.dayNum!=null) mapA.set(e.dayNum,e);});
      entriesB.forEach(e=>{ if(e.dayNum!=null) mapB.set(e.dayNum,e);});
      const days = Array.from(mapA.keys()).filter(d=>mapB.has(d)).sort((a,b)=>a-b);
      let bothWork=0,sameShift=0;
      const detail=[];
      const nameA=nameAEl.value.trim()||"A";
      const nameB=nameBEl.value.trim()||"B";
      days.forEach(day=>{
        const ea=mapA.get(day), eb=mapB.get(day);
        const aWork=isWorkType(ea.typeKey), bWork=isWorkType(eb.typeKey);
        if(aWork && bWork) bothWork++;
        if(aWork && bWork && ea.typeKey===eb.typeKey){
          sameShift++;
          const w=ea.weekStr?`（${ea.weekStr}）`:"";
          detail.push(
            `${ea.dateStr}${w}\n`+
            `- ${nameA}：${TYPE_NAME[ea.typeKey]||""} ${ea.displayShift}\n`+
            `- ${nameB}：${TYPE_NAME[eb.typeKey]||""} ${eb.displayShift}\n`+
            `→ 同班次\n`
          );
        }
      });
      let summary=
        `两人有排班重叠的日期：${days.length} 天\n`+
        `其中，两人都上班的日期：${bothWork} 天\n`+
        `两人同班次上班的日期：${sameShift} 天\n\n`;
      if(!detail.length){
        summary+="目前没有找到两人「同班次」上班的日期。";
      }else{
        summary+="以下是两人同班次上班的具体日期：\n\n"+detail.join("\n");
      }
      outputCompare.value=summary;
      setStatus2("已生成对比结果","ok");
    }catch(e){
      outputCompare.value="";
      setStatus2(e.message||"对比失败","error");
    }
  };
  btnClear2.onclick=()=>{
    inputA.value=""; inputB.value=""; outputCompare.value="";
    nameAEl.value=""; nameBEl.value="";
    setStatus2("已清空","ok");
  };

  // ---------- 模式 3：班次查人 ----------
  const inputRaw3 = document.getElementById("inputRaw3");
  const dateOverride = document.getElementById("dateOverride");
  const weekOverride = document.getElementById("weekOverride");
  const status3 = document.getElementById("status3");
  const outputText3 = document.getElementById("outputText3");
  const stats3 = document.getElementById("stats3");
  const btnClear3 = document.getElementById("btnClear3");
  const btnShiftPeople = document.getElementById("btnShiftPeople");
  function setStatus3(t,type){if(!t){status3.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status3.innerHTML=`<span class="${c}">${t}</span>`;}

  btnShiftPeople.onclick=()=>{
    try{
      const raw=inputRaw3.value;
      const lines=raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if(!lines.length) throw new Error("请先粘贴内容");
      const dateRe=/(\d{1,2})\s*月\s*(\d{1,2})\s*日/;
      const weekRe=/星期[一二三四五六日天]/;

      const dateIdx=lines.findIndex(l=>dateRe.test(l));
      if(dateIdx===-1) throw new Error("未找到日期行（例如 12月4日）");

      let dateLabel=dateOverride.value.trim()||lines[dateIdx];
      const weekLine=(lines[dateIdx+1]&&weekRe.test(lines[dateIdx+1]))?lines[dateIdx+1]:"";
      let weekLabel=weekOverride.value.trim()||weekLine;

      const rawNameLines=lines.slice(0,dateIdx);
      const ignoreKeys=["班表","IM号","大客户经理","吉隆坡","支援","支援账户组","VIP"];
      const names=rawNameLines.filter(l=>{
        if(!l) return false;
        if(["白","中","晚","夜"].includes(l)) return false;
        if(dateRe.test(l)||weekRe.test(l)) return false;
        return !ignoreKeys.some(k=>l.includes(k));
      });
      if(!names.length) throw new Error("未识别到姓名，请确认上半部分是姓名列表（一行一个人）");

      const afterIdx=weekLine?dateIdx+2:dateIdx+1;
      const timeTokens=[];
      for(let i=afterIdx;i<lines.length;i++){
        const parts=lines[i].split(/\s+/);
        parts.forEach(tok=>{
          const t=tok.trim().toUpperCase();
          if(!t) return;
          if(/^\d{1,2}:\d{2}$/.test(t)||t==="AL"||t==="OFF"||t==="REST"){
            timeTokens.push(t);
          }
        });
      }
      if(!timeTokens.length) throw new Error("未识别到时间/班次（如 9:00 / 15:00 / AL / OFF）");

      const count=Math.min(names.length,timeTokens.length);
      const stats={
        zaozao:0,bai:0,zhong:0,wan:0,wanwan:0,ye:0,
        nianjia:0,rest:0,chuqin:0
      };
      const groups={ZAOZAO:[],BAI:[],ZHONG:[],WAN:[],WANWAN:[],YE:[],NIANJIA:[],REST:[]};

      for(let i=0;i<count;i++){
        const name=names[i];
        const rawShift=timeTokens[i];
        const typeKey=classifyShift(rawShift,stats);
        if(!typeKey) continue;
        groups[typeKey].push({name,rawShift});
      }
      stats.chuqin=stats.zaozao+stats.bai+stats.zhong+stats.wan+stats.wanwan+stats.ye;

      const order=["ZAOZAO","BAI","ZHONG","WAN","WANWAN","YE","NIANJIA","REST"];
      const out=[];
      const headerWeek=weekLabel?`（${weekLabel}）`:"";
      out.push(`${dateLabel}${headerWeek}各班次人员\n`);
      order.forEach(key=>{
        const arr=groups[key];
        if(!arr||!arr.length) return;
        const label=TYPE_NAME[key]||key;
        let title=label;
        if(isWorkType(key)){
          const first=arr[0].rawShift;
          title+= " " + formatShift(first);
        }
        out.push(`${title}（共 ${arr.length} 人）：`);
        arr.forEach(item=>{ out.push(`- ${item.name}`); });
        out.push("");
      });
      outputText3.value=out.join("\n");
      updateStatsBox(stats,stats3);
      setStatus3("已生成班次人员列表","ok");
    }catch(e){
      outputText3.value=""; stats3.innerHTML="";
      setStatus3(e.message||"生成失败","error");
    }
  };
  btnClear3.onclick=()=>{
    inputRaw3.value=""; outputText3.value=""; stats3.innerHTML="";
    dateOverride.value=""; weekOverride.value="";
    setStatus3("已清空","ok");
  };

  // ---------- 模式 4：按日期查代码 ----------
  const inputRaw4 = document.getElementById("inputRaw4");
  const daySelect4 = document.getElementById("daySelect4");
  const codeSelect4 = document.getElementById("codeSelect4");
  const btnParse4 = document.getElementById("btnParse4");
  const btnClear4 = document.getElementById("btnClear4");
  const btnQuery4 = document.getElementById("btnQuery4");
  const status4 = document.getElementById("status4");
  const outputText4 = document.getElementById("outputText4");
  let sheet4 = null;
  function setStatus4(t,type){if(!t){status4.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status4.innerHTML=`<span class="${c}">${t}</span>`;}

  btnParse4.onclick=()=>{
    try{
      const raw=inputRaw4.value;
      sheet4=parseFullSheet(raw);
      // 填日期下拉
      daySelect4.innerHTML='<option value="">请选择日期</option>';
      sheet4.days.forEach(d=>{
        const opt=document.createElement("option");
        opt.value=d.day;
        opt.textContent=d.label;
        daySelect4.appendChild(opt);
      });
      codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
      outputText4.value="";
      setStatus4("解析成功，请选择日期和代码","ok");
    }catch(e){
      sheet4=null;
      daySelect4.innerHTML='<option value="">请选择日期</option>';
      codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
      outputText4.value="";
      setStatus4(e.message||"解析失败","error");
    }
  };

  daySelect4.onchange=()=>{
    if(!sheet4){return;}
    const day=parseInt(daySelect4.value,10);
    if(!day){codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';return;}
    const set=new Set();
    sheet4.staffRows.forEach(r=>{
      const v=r.codes[day];
      if(v && v.trim()!=="") set.add(v.trim());
    });
    const list=Array.from(set).sort();
    codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
    list.forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c;
      opt.textContent=c;
      codeSelect4.appendChild(opt);
    });
  };

  btnQuery4.onclick=()=>{
    try{
      if(!sheet4) throw new Error("请先解析整页表格");
      const day=parseInt(daySelect4.value,10);
      const code=(codeSelect4.value||"").trim();
      if(!day) throw new Error("请选择日期");
      if(!code) throw new Error("请选择代码 / 班次");
      const names=[];
      sheet4.staffRows.forEach(r=>{
        const v=(r.codes[day]||"").trim();
        if(v.toUpperCase()===code.toUpperCase()) names.push(r.name);
      });
      const label=sheet4.dayToLabel[day] || `本月第${day}天`;
      let text=`${label} 代码 ${code} 对应人员（共 ${names.length} 人）：\n`;
      if(!names.length){
        text+="\n当前日期没有该代码。";
      }else{
        names.forEach(n=>{ text+=`\n- ${n}`; });
      }
      outputText4.value=text;
      setStatus4("查询完成","ok");
    }catch(e){
      outputText4.value="";
      setStatus4(e.message||"查询失败","error");
    }
  };

  btnClear4.onclick=()=>{
    inputRaw4.value="";
    sheet4=null;
    daySelect4.innerHTML='<option value="">请选择日期</option>';
    codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
    outputText4.value="";
    setStatus4("已清空","ok");
  };

  // ---------- 模式 5：整月代码统计 ----------
  const inputRaw5 = document.getElementById("inputRaw5");
  const codeInput5 = document.getElementById("codeInput5");
  const btnClear5 = document.getElementById("btnClear5");
  const btnStats5 = document.getElementById("btnStats5");
  const status5 = document.getElementById("status5");
  const outputText5 = document.getElementById("outputText5");
  function setStatus5(t,type){if(!t){status5.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status5.innerHTML=`<span class="${c}">${t}</span>`;}

  btnStats5.onclick=()=>{
    try{
      const raw=inputRaw5.value;
      const sheet=parseFullSheet(raw);
      const code=(codeInput5.value.trim()||"MC").toUpperCase();
      const countMap=new Map();
      sheet.staffRows.forEach(r=>{
        let cnt=0;
        sheet.days.forEach(d=>{
          const v=(r.codes[d.day]||"").trim().toUpperCase();
          if(v===code) cnt++;
        });
        if(cnt>0) countMap.set(r.name,cnt);
      });
      const list=Array.from(countMap.entries()).sort((a,b)=>{
        if(b[1]!==a[1]) return b[1]-a[1];
        return a[0].localeCompare(b[0]);
      });
      let total=0;
      list.forEach(([_,c])=>{ total+=c; });
      let text=`整个月代码 ${code} 统计：\n\n`;
      text+=`共有 ${list.length} 人出现过该代码，总次数 ${total} 次。\n\n`;
      if(!list.length){
        text+="当前表格中未找到该代码。";
      }else{
        list.forEach(([name,c])=>{
          text+=`- ${name}：${code} ${c} 次\n`;
        });
      }
      outputText5.value=text;
      setStatus5("统计完成","ok");
    }catch(e){
      outputText5.value="";
      setStatus5(e.message||"统计失败","error");
    }
  };

  btnClear5.onclick=()=>{
    inputRaw5.value="";
    codeInput5.value="";
    outputText5.value="";
    setStatus5("已清空","ok");
  };
</script>
</body>
</html>
