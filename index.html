<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>班表转换器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, SF Pro Text, Segoe UI, system-ui, sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #000000 100%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 1180px;
      height: 92vh;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
      border-radius: 24px;
      box-shadow: 0 28px 70px rgba(0,0,0,0.80);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .app-header {
      margin-bottom: 8px;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      line-height: 1.5;
    }
    .tabs {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.9);
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.12s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #f9fafb;
      border-color: rgba(129,140,248,0.9);
      box-shadow: 0 6px 18px rgba(37,99,235,0.8);
    }
    .app-body {
      flex: 1;
      margin-top: 10px;
      min-height: 0;
      position: relative;
    }
    .mode {
      position: absolute;
      inset: 0;
      display: none;
    }
    .mode.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      min-height: 0;
    }
    .panel {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.15), rgba(15,23,42,0.98));
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel-header {
      margin-bottom: 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #e5e7eb;
    }
    .panel-header span.right {
      font-size: 11px;
      color: #9ca3af;
    }
    .input-area,
    .output-area {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: #020617;
      padding: 8px;
      width: 100%;
      font-size: 13px;
      color: #e5e7eb;
      outline: none;
      line-height: 1.45;
      overflow: auto;
    }
    .input-area::placeholder,
    .output-area::placeholder {
      color: #4b5563;
    }
    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 6px;
      color: #e5e7eb;
      background: rgba(31,41,55,0.95);
      border: 1px solid rgba(75,85,99,0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s, box-shadow 0.12s, background 0.12s;
    }
    .btn:hover {
      background: rgba(55,65,81,0.95);
      box-shadow: 0 4px 14px rgba(15,23,42,0.8);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 6px rgba(15,23,42,0.9);
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border: 1px solid rgba(129,140,248,0.9);
      box-shadow: 0 8px 24px rgba(37,99,235,0.85);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8, #6d28d9);
    }
    .status {
      font-size: 11px;
      margin-top: 6px;
      min-height: 16px;
    }
    .ok { color: #4ade80; }
    .error { color: #f97373; }
    .field-line {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .field-line input,
    .field-line select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .stats {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #e5e7eb;
      padding-top: 6px;
      border-top: 1px solid rgba(55,65,81,0.7);
      line-height: 1.8;
    }
    .compare-block {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px;
      background: rgba(15,23,42,0.7);
    }
    .compare-block label {
      font-size: 12px;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    @media(max-width:960px){
      .app-body { height: auto; }
      .mode.active { grid-template-columns: 1fr; position: static; }
      .mode { position: static; }
      .app { height: auto; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-header">
    <div class="title">班表转换器</div>
    <div class="subtitle">
      直接从飞书复制一整个月的日期和星期，再复制对应的上班时间，粘贴到左侧即可一键生成文字版班表和统计结果。<br>
      模式支持：单人班表 · 班表对比 · 班次查人 · 按日期查代码 · 整月代码统计。
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-mode="single">单人班表</button>
      <button class="tab-btn" data-mode="compare">班表对比</button>
      <button class="tab-btn" data-mode="shiftpeople">班次查人</button>
      <button class="tab-btn" data-mode="codebyday">按日期查代码</button>
      <button class="tab-btn" data-mode="codestats">整月代码统计</button>
    </div>
  </div>

  <div class="app-body">
    <!-- 模式 1：单人班表 -->
    <div class="mode active" id="mode-single">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴飞书排班内容</span>
          <span class="right">示例：日期行 + 星期行 + 时间行</span>
        </div>
        <textarea id="inputRaw1" class="input-area"
          placeholder="例如：&#10;12月1日 12月2日 12月3日...&#10;星期一 星期二 星期三...&#10;9:00 9:00 OFF ..."
        ></textarea>
        <div class="field-line">
          <input id="titleInput1" type="text" placeholder="标题名称（如 积宏）">
          <select id="yearSelect1"></select>
          <select id="monthSelect1"></select>
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnClear1">清空</button>
          <button class="btn btn-primary" id="btnParse1">生成时间表</button>
        </div>
        <div class="status" id="status1"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 结果预览</span>
          <span class="right">可复制 / 下载 TXT / 导出 iOS 日历</span>
        </div>
        <textarea id="outputText1" class="output-area"
          placeholder="会在这里自动生成文字版班表..."
        ></textarea>
        <div style="margin-top:8px;">
          <button class="btn" id="btnCopy1">复制</button>
          <button class="btn" id="btnDownloadTxt1">下载 TXT</button>
          <button class="btn" id="btnDownloadICS1">导出日历 (ICS)</button>
        </div>
        <div class="stats" id="stats1"></div>
      </div>
    </div>

    <!-- 模式 2：班表对比（多人） -->
    <div class="mode" id="mode-compare">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴多人排班</span>
          <span class="right">第 1 人需要包含日期，其余可只贴时间行</span>
        </div>

        <div class="field-line">
          <span style="font-size:12px;color:#9ca3af;">对比人数</span>
          <select id="compareCount">
            <option value="2">2 人</option>
            <option value="3">3 人</option>
            <option value="4">4 人</option>
          </select>
        </div>

        <div id="compareInputs">
          <div class="compare-block" data-index="1">
            <label>成员 1（作为参考：必须包含日期行 + 星期行 + 时间行）</label>
            <textarea id="cmpInput1" class="input-area" style="height:90px;"
              placeholder="成员 1 的排班（日期行 + 星期行 + 时间行）"
            ></textarea>
            <div class="field-line">
              <input id="cmpName1" type="text" placeholder="成员 1 名字（如 积宏）">
            </div>
          </div>

          <div class="compare-block" data-index="2">
            <label>成员 2（可只粘贴时间行：9:00 9:00 15:00 ...）</label>
            <textarea id="cmpInput2" class="input-area" style="height:90px;"
              placeholder="成员 2 的排班（可只有时间行）"
            ></textarea>
            <div class="field-line">
              <input id="cmpName2" type="text" placeholder="成员 2 名字">
            </div>
          </div>

          <div class="compare-block" data-index="3" style="display:none;">
            <label>成员 3（可只粘贴时间行：9:00 9:00 15:00 ...）</label>
            <textarea id="cmpInput3" class="input-area" style="height:90px;"
              placeholder="成员 3 的排班（可只有时间行）"
            ></textarea>
            <div class="field-line">
              <input id="cmpName3" type="text" placeholder="成员 3 名字">
            </div>
          </div>

          <div class="compare-block" data-index="4" style="display:none;">
            <label>成员 4（可只粘贴时间行：9:00 9:00 15:00 ...）</label>
            <textarea id="cmpInput4" class="input-area" style="height:90px;"
              placeholder="成员 4 的排班（可只有时间行）"
            ></textarea>
            <div class="field-line">
              <input id="cmpName4" type="text" placeholder="成员 4 名字">
            </div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button class="btn" id="btnClear2">清空</button>
          <button class="btn btn-primary" id="btnCompare">生成对比</button>
        </div>
        <div class="status" id="status2"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 共同上班统计</span>
          <span class="right">统计所有人都上班 / 同班次的日期</span>
        </div>
        <textarea id="outputCompare" class="output-area"
          placeholder="示例：&#10;本次对比人数：3 人&#10;所有人都上班的日期：15 天&#10;所有人同班次上班的日期：9 天&#10;&#10;同班次上班的具体日期如下：&#10;&#10;12月3日（星期三），白班 09:00 - 18:00&#10;..."
        ></textarea>
      </div>
    </div>

    <!-- 模式 3：班次查人（多日期 + 下拉选日期） -->
    <div class="mode" id="mode-shiftpeople">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴直列的人员 + 多天时间</span>
          <span class="right">上面是姓名列表，下面是多天的日期 + 时间</span>
        </div>
        <textarea id="inputRaw3" class="input-area"
          placeholder="例如：&#10;(一大串姓名，每行一个，格式为中英混合：Derrick Chin 陈伟聪 / 梅志豪 Orien Mei...)&#10;...&#10;12月4日&#10;星期四&#10;9:00&#10;15:00&#10;9:00&#10;16:00&#10;OFF&#10;...&#10;12月5日&#10;星期五&#10;...&#10;（可包含整个月多天）"
        ></textarea>
        <div class="field-line">
          <select id="dateSelect3">
            <option value="">请选择日期</option>
          </select>
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="btnClear3">清空</button>
          <button class="btn btn-primary" id="btnShiftPeople">解析 / 刷新日期列表</button>
        </div>
        <div class="status" id="status3"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 各班次对应的人员</span>
          <span class="right">选择日期后自动展示</span>
        </div>
        <textarea id="outputText3" class="output-area"
          placeholder="选择某一天后，这里会按班次显示人员，例如：&#10;12月4日（星期四）各班次人员&#10;白班 09:00 - 18:00（共 X 人）：&#10;- Derrick Chin 陈伟聪&#10;- 梅志豪 Orien Mei..."
        ></textarea>
        <div class="stats" id="stats3"></div>
      </div>
    </div>

    <!-- 模式 4：按日期查代码 -->
    <div class="mode" id="mode-codebyday">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴整页排班表</span>
          <span class="right">姓名列需为中英混合姓名</span>
        </div>
        <textarea id="inputRaw4" class="input-area"
          placeholder="从飞书 / 表格复制整页内容：上方是日期行、星期行，下面是每个人每天的代码或时间（9:00 / MC / OFF / REST ...）。姓名必须类似 Derrick Chin 陈伟聪 / 梅志豪 Orien Mei。"
        ></textarea>
        <div class="field-line">
          <button class="btn" id="btnParse4">解析表格</button>
          <button class="btn" id="btnClear4">清空</button>
        </div>
        <div class="field-line">
          <select id="daySelect4">
            <option value="">请选择日期</option>
          </select>
          <select id="codeSelect4">
            <option value="">请选择代码 / 班次</option>
          </select>
          <button class="btn btn-primary" id="btnQuery4">查询</button>
        </div>
        <div class="status" id="status4"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 查询结果</span>
          <span class="right">指定日期 + 代码 → 谁是这个代码 / 班次</span>
        </div>
        <textarea id="outputText4" class="output-area"
          placeholder="解析后，可选择某一天 + 某个代码或时间（如 9:00、MC、OFF），这里会显示当天该代码对应的所有人员名单。不会再把 12月12日 这种日期当成代码。"
        ></textarea>
      </div>
    </div>

    <!-- 模式 5：整月代码统计 -->
    <div class="mode" id="mode-codestats">
      <div class="panel">
        <div class="panel-header">
          <span>1. 粘贴整页排班表</span>
          <span class="right">姓名列需为中英混合姓名</span>
        </div>
        <textarea id="inputRaw5" class="input-area"
          placeholder="同上：姓名 + 日期列。整页复制后贴进来，例如要统计整个月 MC 的次数。姓名必须类似 Derrick Chin 陈伟聪 / 梅志豪 Orien Mei。"
        ></textarea>
        <div class="field-line">
          <input id="codeInput5" type="text" placeholder="统计的代码（默认 MC）">
        </div>
        <div class="field-line">
          <button class="btn" id="btnClear5">清空</button>
          <button class="btn btn-primary" id="btnStats5">统计代码次数</button>
        </div>
        <div class="status" id="status5"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span>2. 统计结果</span>
          <span class="right">按人统计该代码在整月出现次数</span>
        </div>
        <textarea id="outputText5" class="output-area"
          placeholder="这里会显示：每个人 MC（或其它代码）在整个月出现了多少次，会按次数从高到低排序。"
        ></textarea>
      </div>
    </div>

  </div>
</div>

<script>
  const pad = n => (n < 10 ? "0" + n : "" + n);

  // 识别“中英混合姓名”（如 Derrick Chin 陈伟聪 / 梅志豪 Orien Mei）
  function isNameLine(line) {
    const s = line.trim();
    if (!s) return false;
    const clean = s.replace(/^[-•·\s]+/, "");
    if (/^\d{1,2}:\d{2}$/.test(clean)) return false;
    if (/^\d+(\.\d+)?$/.test(clean)) return false;
    if (/^\d/.test(clean)) return false;
    if (/OFF|REST|AL|MC|UPL|PCU|PH|MT|PL|ML|CL|HOSP|AWOL|GL/i.test(clean)) return false;

    const hasHan = /[\u4e00-\u9fff]/.test(clean);
    const hasLat = /[A-Za-z]/.test(clean);
    return hasHan && hasLat;
  }

  const TYPE_NAME = {
    ZAOZAO: "早早班",
    BAI: "白班",
    ZHONG: "中班",
    WAN: "晚班",
    WANWAN: "晚晚班",
    YE: "夜班",
    NIANJIA: "年假",
    REST: "休息"
  };

  const CODE_WHITELIST = new Set([
    "TRAINING","SUPPORT","BUDDY","PRACTICAL",
    "AL","M-AL-1H","M-AL-2H","A-AL-1H","A-AL-2H",
    "N-AL-1H","N-AL-2H","MN-AL-1H","MN-AL-2H",
    "MC","M-MC-1H","M-MC-2H","A-MC-1H","A-MC-2H",
    "N-MC-1H","N-MC-2H","MN-MC-1H","MN-MC-2H",
    "UPL","M-UPL-1H","M-UPL-2H","A-UPL-1H","A-UPL-2H",
    "N-UPL-1H","N-UPL-2H","MN-UPL-1H","MN-UPL-2H",
    "PCU","M-PCU-1H","M-PCU-2H","A-PCU-1H","A-PCU-2H",
    "N-PCU-1H","N-PCU-2H","MN-PCU-1H","MN-PCU-2H",
    "PH","MT","PL","ML","CL","HOSP",
    "AWOL","M-AWOL-1H","M-AWOL-2H","A-AWOL-1H","A-AWOL-2H",
    "N-AWOL-1H","N-AWOL-2H","MN-AWOL-1H","MN-AWOL-2H",
    "GL","M-GL-1H","M-GL-2H","A-GL-1H","A-GL-2H",
    "N-GL-1H","N-GL-2H","MN-GL-1H","MN-GL-2H",
    "RESIGN","OFF","REST"
  ]);

  function isTimeToken(s) {
    return /^\d{1,2}:\d{2}(\s*-\s*\d{1,2}:\d{2})?$/.test(s);
  }
  function isCodeOrShiftToken(s) {
    const t = s.trim();
    if (!t) return false;
    if (t.includes("月") || t.includes("日")) return false;
    if (isTimeToken(t)) return true;
    if (CODE_WHITELIST.has(t.toUpperCase())) return true;
    return false;
  }

  function splitRow(line) {
    return line.trim().split(/\s+/).filter(Boolean);
  }
  function isWorkType(key) {
    return ["ZAOZAO","BAI","ZHONG","WAN","WANWAN","YE"].includes(key);
  }

  function classifyShift(rawShift, stats) {
    const s = rawShift.trim().toUpperCase();
    if (!s) return null;

    if (s === "AL") {
      stats.nianjia++;
      return "NIANJIA";
    }
    if (s === "OFF" || s === "REST") {
      stats.rest++;
      return "REST";
    }

    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (m) {
      const h  = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      if (mm === 0) {
        if (h === 8)  { stats.zaozao++; return "ZAOZAO"; }
        if (h === 9)  { stats.bai++;    return "BAI";    }
        if (h === 12) { stats.zhong++;  return "ZHONG";  }
        if (h === 15) { stats.wan++;    return "WAN";    }
        if (h === 16) { stats.wanwan++; return "WANWAN"; }
        if (h === 0 || h === 24) { stats.ye++; return "YE"; }
      }
    }
    return null;
  }

  function formatShift(rawShift) {
    const s = rawShift.trim();
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return s;

    const startHour = parseInt(m[1], 10);
    const minute = parseInt(m[2], 10);
    const added = startHour + 9;
    const endHour24 = added % 24;
    const displayEndHour = (added >= 24 && endHour24 === 0) ? 24 : endHour24;

    return `${pad(startHour)}:${pad(minute)} - ${pad(displayEndHour)}:${pad(minute)}`;
  }

  function parseFeishuSchedule(raw, monthHint) {
    const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) throw new Error("请先粘贴排班内容");

    const rows = lines.map(splitRow);
    const dateRe = /(\d{1,2})\s*月\s*(\d{1,2})\s*日/;

    let startCol = null;
    rows.forEach(r => {
      r.forEach((c, i) => {
        if (dateRe.test(c)) {
          if (startCol === null || i < startCol) startCol = i;
        }
      });
    });
    if (startCol === null) throw new Error("未识别到日期行（例如 12月1日）");

    const colCount = Math.max(...rows.map(r => r.length));
    const dates = new Array(colCount).fill("");
    const weeks = new Array(colCount).fill("");
    const days  = new Array(colCount).fill(null);

    rows.forEach(r => {
      for (let i = startCol; i < r.length; i++) {
        const c = r[i];
        const dm = c.match(dateRe);
        if (dm) {
          dates[i] = c;
          const dayNum = parseInt(dm[2], 10);
          if (!isNaN(dayNum)) days[i] = dayNum;
        }
        if (/星期[一二三四五六日天]/.test(c)) weeks[i] = c;
      }
    });

    const lastRow = rows[rows.length - 1];
    const stats = {
      zaozao:0, bai:0, zhong:0, wan:0, wanwan:0, ye:0,
      nianjia:0, rest:0, chuqin:0
    };
    const entries = [];
    const events = [];

    for (let i = startCol; i < lastRow.length; i++) {
      const rawShift = (lastRow[i] || "").trim();
      if (!rawShift) continue;
      const typeKey = classifyShift(rawShift, stats);

      let dateStr = dates[i];
      let dayNum = days[i];
      if (!dateStr) {
        const dayIndex = i - startCol + 1;
        if (monthHint) {
          dateStr = `${monthHint}月${dayIndex}日`;
          dayNum = dayIndex;
        } else {
          dateStr = `第${dayIndex}天`;
        }
      }
      const weekStr = weeks[i] || "";
      const displayShift = formatShift(rawShift);

      entries.push({ dateStr, weekStr, dayNum, rawShift, typeKey, displayShift });

      const timeMatch = rawShift.match(/^(\d{1,2}):(\d{2})$/);
      if (timeMatch && isWorkType(typeKey) && monthHint && dayNum) {
        const startHour   = parseInt(timeMatch[1], 10);
        const startMinute = parseInt(timeMatch[2], 10);
        const added       = startHour + 9;
        const endHour24   = added % 24;
        const endHour     = (added >= 24 && endHour24 === 0) ? 24 : endHour24;
        const endMinute   = startMinute;
        events.push({ day: dayNum, startHour, startMinute, endHour, endMinute, typeKey });
      }
    }

    stats.chuqin =
      stats.zaozao + stats.bai + stats.zhong +
      stats.wan + stats.wanwan + stats.ye;

    return { entries, stats, events };
  }

  // B 只给时间：复用 A 的日期
  function parseTimesOnly(raw, refEntries) {
    const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) throw new Error("排班内容为空");

    const lastLine = lines[lines.length - 1];
    const tokens = splitRow(lastLine);
    if (!tokens.length) throw new Error("时间行为空");

    const entries = [];
    for (let i = 0; i < refEntries.length && i < tokens.length; i++) {
      const ref = refEntries[i];
      const rawShift = tokens[i].trim();
      if (!rawShift) continue;
      const dummyStats = {
        zaozao:0,bai:0,zhong:0,wan:0,wanwan:0,ye:0,
        nianjia:0,rest:0,chuqin:0
      };
      const typeKey = classifyShift(rawShift, dummyStats);
      const displayShift = formatShift(rawShift);
      entries.push({
        dateStr: ref.dateStr,
        weekStr: ref.weekStr,
        dayNum:  ref.dayNum,
        rawShift,
        typeKey,
        displayShift
      });
    }
    return entries;
  }

  // 解析整页排班（多行姓名 + 日期列）
  function parseFullSheet(raw) {
    const lines = raw.split(/\r?\n/).map(l => l.replace(/\s+$/,"")).filter(l => l !== "");
    if (!lines.length) throw new Error("请先粘贴整页排班内容");

    const rows = lines.map(line => line.split(/\t+/).map(c => c.trim()));
    const dateRe = /(\d{1,2})\s*月\s*(\d{1,2})\s*日/;
    const weekRe = /星期[一二三四五六日天]/;

    let dateRowIndex = -1;
    let startCol = null;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const indices = [];
      row.forEach((c, idx) => {
        if (dateRe.test(c)) indices.push(idx);
      });
      if (indices.length >= 3) {
        dateRowIndex = i;
        startCol = Math.min(...indices);
        break;
      }
    }
    if (dateRowIndex === -1) throw new Error("整页表格中未识别到日期行（例如 12月1日 12月2日 ...）");

    let weekRowIndex = -1;
    for (let i = dateRowIndex + 1; i < rows.length; i++) {
      const row = rows[i];
      if (row.some(c => weekRe.test(c))) {
        weekRowIndex = i;
        break;
      }
    }

    const dateRow = rows[dateRowIndex];
    const days = [];
    const dayToLabel = {};
    for (let col = startCol; col < dateRow.length; col++) {
      const c = dateRow[col];
      const m = c && c.match(dateRe);
      let dayNum;
      if (m) {
        dayNum = parseInt(m[2], 10);
      } else {
        dayNum = col - startCol + 1;
      }
      const label = c || `本月第${dayNum}天`;
      days.push({ colIndex: col, day: dayNum, label });
      dayToLabel[dayNum] = label;
    }

    const staffRows = [];
    for (let i = (weekRowIndex !== -1 ? weekRowIndex + 1 : dateRowIndex + 1); i < rows.length; i++) {
      const row = rows[i];
      let hasValue = false;
      for (const d of days) {
        const v = row[d.colIndex];
        if (v && v.trim() !== "") {
          hasValue = true;
          break;
        }
      }
      if (!hasValue) continue;

      const nameParts = row.slice(0, startCol).map(c => c.trim()).filter(Boolean);
      const name = nameParts.join(" ").trim();
      if (!name || !isNameLine(name)) continue;

      const codes = {};
      for (const d of days) {
        const v = row[d.colIndex] || "";
        if (v && v.trim() !== "") {
          codes[d.day] = v.trim();
        }
      }
      staffRows.push({ name, codes });
    }

    if (!staffRows.length) {
      throw new Error("未识别到有效的姓名行，请确认表格中包含姓名（中英混合） + 各天代码。");
    }
    return { days, dayToLabel, staffRows };
  }

  function buildICS(events, year, month, name) {
    const now = new Date();
    const dtstamp =
      now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) +
      "T" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());

    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//ScheduleConverter//CN");

    events.forEach((e, idx) => {
      const y = parseInt(year, 10);
      const m = parseInt(month, 10);
      const d = e.day;

      const dtstart = `${y}${pad(m)}${pad(d)}T${pad(e.startHour)}${pad(e.startMinute)}00`;
      const endHour = e.endHour === 24 ? 23 : e.endHour;
      const endMinute = e.endHour === 24 ? 59 : e.endMinute;
      const dtend = `${y}${pad(m)}${pad(d)}T${pad(endHour)}${pad(endMinute)}00`;

      const label = TYPE_NAME[e.typeKey] || "上班";
      const summary = label;
      const uid = `${y}${pad(m)}${pad(d)}-${pad(e.startHour)}${pad(e.startMinute)}-${idx}@schedule.local`;

      lines.push("BEGIN:VEVENT");
      lines.push("UID:" + uid);
      lines.push("DTSTAMP:" + dtstamp);
      lines.push("DTSTART:" + dtstart);
      lines.push("DTEND:" + dtend);
      lines.push("SUMMARY:" + summary);
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");
    return lines.join("\r\n");
  }

  // Tab 切换
  const tabBtns = document.querySelectorAll(".tab-btn");
  const modes = {
    single:     document.getElementById("mode-single"),
    compare:    document.getElementById("mode-compare"),
    shiftpeople:document.getElementById("mode-shiftpeople"),
    codebyday:  document.getElementById("mode-codebyday"),
    codestats:  document.getElementById("mode-codestats")
  };
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const mode = btn.dataset.mode;
      tabBtns.forEach(b => b.classList.toggle("active", b === btn));
      Object.keys(modes).forEach(key => {
        modes[key].classList.toggle("active", key === mode);
      });
    });
  });

  // ---------- 模式 1 ----------
  const inputRaw1 = document.getElementById("inputRaw1");
  const outputText1 = document.getElementById("outputText1");
  const titleInput1 = document.getElementById("titleInput1");
  const yearSelect1 = document.getElementById("yearSelect1");
  const monthSelect1 = document.getElementById("monthSelect1");
  const status1 = document.getElementById("status1");
  const stats1 = document.getElementById("stats1");
  const btnParse1 = document.getElementById("btnParse1");
  const btnCopy1  = document.getElementById("btnCopy1");
  const btnClear1 = document.getElementById("btnClear1");
  const btnDownloadTxt1 = document.getElementById("btnDownloadTxt1");
  const btnDownloadICS1 = document.getElementById("btnDownloadICS1");
  let lastEvents1 = [];

  function setStatus1(text, type) {
    if (!text) { status1.innerHTML = ""; return; }
    const cls = type === "ok" ? "ok" : type === "error" ? "error" : "";
    status1.innerHTML = `<span class="${cls}">${text}</span>`;
  }
  (function initYM1(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth() + 1;
    for (let i = y - 1; i <= y + 3; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i + "年";
      if (i === y) o.selected = true;
      yearSelect1.appendChild(o);
    }
    for (let i = 1; i <= 12; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i + "月";
      if (i === m) o.selected = true;
      monthSelect1.appendChild(o);
    }
  })();

  function updateStatsBox(stats, el) {
    el.innerHTML =
      `班次统计（仅展示，不会写入文本）：<br>` +
      `早早：${stats.zaozao}　白：${stats.bai}　中：${stats.zhong}　晚：${stats.wan}　晚晚：${stats.wanwan}　夜：${stats.ye}<br>` +
      `年假：${stats.nianjia}　休息：${stats.rest}　出勤：${stats.chuqin}`;
  }

  btnParse1.onclick = () => {
    try {
      const raw = inputRaw1.value;
      const month = parseInt(monthSelect1.value, 10) || null;
      const { entries, stats, events } = parseFeishuSchedule(raw, month);
      lastEvents1 = events;

      const name  = titleInput1.value.trim() || "我的";
      const year  = yearSelect1.value;
      const monthText = monthSelect1.value;
      const titleLine = `${name}的 ${year} 年 ${monthText} 月时间表`;

      const lines = entries.map(e => {
        const w = e.weekStr ? `（${e.weekStr}）` : "";
        return `${e.dateStr}${w}：${e.displayShift}`;
      });

      outputText1.value = titleLine + "\n" + lines.join("\n");
      updateStatsBox(stats, stats1);
      setStatus1("已生成班表与统计", "ok");
    } catch (e) {
      lastEvents1 = [];
      stats1.innerHTML = "";
      setStatus1(e.message || "解析失败", "error");
    }
  };
  btnCopy1.onclick = async () => {
    try {
      await navigator.clipboard.writeText(outputText1.value);
      setStatus1("已复制到剪贴板", "ok");
    } catch {
      setStatus1("复制失败，请手动选择复制", "error");
    }
  };
  btnDownloadTxt1.onclick = () => {
    const text = outputText1.value.trim();
    if (!text) { setStatus1("当前没有可下载的内容", "error"); return; }
    const name = (titleInput1.value.trim() || "schedule").replace(/[\\/:*?"<>|]/g,"_");
    const y = yearSelect1.value;
    const m = monthSelect1.value.toString().padStart(2,"0");
    const filename = `${name}_${y}-${m}_班表.txt`;
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href   = url;
    a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus1("已下载 TXT", "ok");
  };
  btnDownloadICS1.onclick = () => {
    if (!lastEvents1.length) { setStatus1("当前没有可导出的班次（请先生成班表）", "error"); return; }
    const y = yearSelect1.value;
    const m = monthSelect1.value;
    const name = titleInput1.value.trim() || "我的";
    const ics = buildICS(lastEvents1, y, m, name);
    const safeName = name.replace(/[\\/:*?"<>|]/g,"_");
    const mm = m.toString().padStart(2,"0");
    const filename = `${safeName}_${y}-${mm}_班表.ics`;
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus1("已导出 iOS 日历文件（ICS）", "ok");
  };
  btnClear1.onclick = () => {
    inputRaw1.value = "";
    outputText1.value = "";
    stats1.innerHTML = "";
    lastEvents1 = [];
    setStatus1("已清空", "ok");
  };

  // ---------- 模式 2：多人对比 ----------
  const compareCountSelect = document.getElementById("compareCount");
  const compareInputs       = document.getElementById("compareInputs");
  const status2             = document.getElementById("status2");
  const outputCompare       = document.getElementById("outputCompare");
  const btnCompare          = document.getElementById("btnCompare");
  const btnClear2           = document.getElementById("btnClear2");

  function setStatus2(text,type){ if(!text){status2.innerHTML="";return;} const cls=type==="ok"?"ok":type==="error"?"error":""; status2.innerHTML=`<span class="${cls}">${text}</span>`;}

  function refreshCompareBlocks() {
    const n = parseInt(compareCountSelect.value, 10) || 2;
    const blocks = compareInputs.querySelectorAll(".compare-block");
    blocks.forEach((b,idx)=>{
      b.style.display = idx < n ? "" : "none";
    });
  }
  compareCountSelect.addEventListener("change", refreshCompareBlocks);
  refreshCompareBlocks();

  btnCompare.onclick = () => {
    try {
      const n = parseInt(compareCountSelect.value, 10) || 2;
      const rawArr  = [];
      const nameArr = [];
      for (let i=1;i<=n;i++){
        const raw  = document.getElementById(`cmpInput${i}`).value.trim();
        const name = document.getElementById(`cmpName${i}`).value.trim() || `成员${i}`;
        if (!raw) throw new Error(`请先粘贴成员 ${i} 的排班内容`);
        rawArr.push(raw);
        nameArr.push(name);
      }
      const month = parseInt(monthSelect1.value,10) || null;

      // 第一个成员：完整解析
      const parsed0  = parseFeishuSchedule(rawArr[0], month);
      const refEntries = parsed0.entries;
      const maps = [];
      maps.push(new Map());
      refEntries.forEach(e=>{ if(e.dayNum!=null) maps[0].set(e.dayNum,e); });

      // 其余成员
      for(let i=1;i<n;i++){
        const raw = rawArr[i];
        let entries;
        try{
          entries = parseFeishuSchedule(raw, month).entries;
        }catch(e){
          if((e.message||"").includes("未识别到日期行")){
            entries = parseTimesOnly(raw, refEntries);
          }else{
            throw new Error(`成员 ${i+1} 的排班解析失败：`+e.message);
          }
        }
        const m = new Map();
        entries.forEach(e=>{ if(e.dayNum!=null) m.set(e.dayNum,e); });
        maps.push(m);
      }

      // 求所有人都存在的日期
      let commonDays = Array.from(maps[0].keys());
      for(let i=1;i<n;i++){
        const keys = new Set(maps[i].keys());
        commonDays = commonDays.filter(d=>keys.has(d));
      }
      commonDays.sort((a,b)=>a-b);

      let allWorkCount = 0;
      let sameShiftCount = 0;
      const detailLines = [];

      commonDays.forEach(day=>{
        const entries = maps.map(m=>m.get(day));
        const allWork = entries.every(e=>isWorkType(e.typeKey));
        if (allWork) allWorkCount++;
        const first = entries[0];
        const sameShift = allWork && entries.every(e=>e.typeKey===first.typeKey);
        if (sameShift){
          sameShiftCount++;
          const w = first.weekStr ? `（${first.weekStr}）` : "";
          const shiftName = TYPE_NAME[first.typeKey] || "";
          detailLines.push(`${first.dateStr}${w}，${shiftName} ${first.displayShift}`);
        }
      });

      let summary =
        `本次对比人数：${n} 人\n` +
        `所有人都上班的日期：${allWorkCount} 天\n` +
        `所有人同班次上班的日期：${sameShiftCount} 天\n\n`;

      if (!detailLines.length) {
        summary += "目前没有找到「所有人同班次」上班的日期。";
      } else {
        summary += "同班次上班的具体日期如下：\n\n" + detailLines.join("\n");
      }

      outputCompare.value = summary;
      setStatus2("已生成对比结果","ok");
    } catch(e){
      outputCompare.value="";
      setStatus2(e.message||"对比失败","error");
    }
  };

  btnClear2.onclick=()=>{
    for(let i=1;i<=4;i++){
      const t=document.getElementById(`cmpInput${i}`); if(t) t.value="";
      const n=document.getElementById(`cmpName${i}`);  if(n) n.value="";
    }
    outputCompare.value="";
    setStatus2("已清空","ok");
  };

  // ---------- 模式 3：班次查人（多日期） ----------
  const inputRaw3   = document.getElementById("inputRaw3");
  const dateSelect3 = document.getElementById("dateSelect3");
  const status3     = document.getElementById("status3");
  const outputText3 = document.getElementById("outputText3");
  const stats3      = document.getElementById("stats3");
  const btnClear3   = document.getElementById("btnClear3");
  const btnShiftPeople = document.getElementById("btnShiftPeople");
  function setStatus3(t,type){if(!t){status3.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status3.innerHTML=`<span class="${c}">${t}</span>`;}

  let shiftPeopleData = null; // { names:[], blocks:[{date, week, tokens:[]}] }

  function parseShiftPeopleStructure(raw){
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) throw new Error("请先粘贴内容");
    const dateRe=/(\d{1,2})\s*月\s*(\d{1,2})\s*日/;
    const weekRe=/星期[一二三四五六日天]/;

    const dateIdxs=[];
    lines.forEach((l,idx)=>{ if(dateRe.test(l)) dateIdxs.push(idx); });
    if(!dateIdxs.length) throw new Error("未找到任何日期行（例如 12月4日）");

    const firstDateIdx = dateIdxs[0];

    // 姓名在最前面
    const rawNameLines = lines.slice(0, firstDateIdx);
    const ignoreKeys=["班表","IM号","大客户经理","吉隆坡","支援","支援账户组","VIP"];
    const names = rawNameLines.filter(l=>{
      if(!l) return false;
      if(ignoreKeys.some(k=>l.includes(k))) return false;
      return isNameLine(l);
    });
    if(!names.length) throw new Error("未识别到姓名，请确认上半部分是姓名列表（中英混合，例如 Derrick Chin 陈伟聪）");

    const blocks=[];
    for(let i=0;i<dateIdxs.length;i++){
      const idx = dateIdxs[i];
      const next = (i+1<dateIdxs.length? dateIdxs[i+1] : lines.length);
      const dateLabel = lines[idx];
      let ptr = idx+1;
      let weekLabel = "";
      if(ptr<next && weekRe.test(lines[ptr])){
        weekLabel = lines[ptr];
        ptr++;
      }
      const timeTokens=[];
      for(let j=ptr;j<next;j++){
        const parts = lines[j].split(/\s+/);
        parts.forEach(tok=>{
          const t = tok.trim().toUpperCase();
          if(!t) return;
          if(/^\d{1,2}:\d{2}$/.test(t) || t==="AL" || t==="OFF" || t==="REST"){
            timeTokens.push(t);
          }
        });
      }
      blocks.push({date:dateLabel, week:weekLabel, tokens:timeTokens});
    }
    if(!blocks.length) throw new Error("未识别到任何日期对应的时间/班次");
    return {names, blocks};
  }

  function renderShiftPeopleForSelected(){
    if(!shiftPeopleData) return;
    const sel = dateSelect3.value;
    if(!sel){ outputText3.value=""; stats3.innerHTML=""; return; }
    const block = shiftPeopleData.blocks.find(b=>b.date===sel);
    if(!block){ outputText3.value=""; stats3.innerHTML=""; return; }

    const names = shiftPeopleData.names;
    const tokens = block.tokens;
    const count  = Math.min(names.length, tokens.length);

    const stats={
      zaozao:0,bai:0,zhong:0,wan:0,wanwan:0,ye:0,
      nianjia:0,rest:0,chuqin:0
    };
    const groups={ZAOZAO:[],BAI:[],ZHONG:[],WAN:[],WANWAN:[],YE:[],NIANJIA:[],REST:[]};

    for(let i=0;i<count;i++){
      const name=names[i];
      const rawShift=tokens[i];
      const typeKey=classifyShift(rawShift,stats);
      if(!typeKey) continue;
      groups[typeKey].push({name,rawShift});
    }
    stats.chuqin=stats.zaozao+stats.bai+stats.zhong+stats.wan+stats.wanwan+stats.ye;

    const order=["ZAOZAO","BAI","ZHONG","WAN","WANWAN","YE","NIANJIA","REST"];
    const out=[];
    const headerWeek = block.week ? `（${block.week}）` : "";
    out.push(`${block.date}${headerWeek}各班次人员\n`);
    order.forEach(key=>{
      const arr=groups[key];
      if(!arr||!arr.length) return;
      const label=TYPE_NAME[key]||key;
      let title=label;
      if(isWorkType(key)){
        const first=arr[0].rawShift;
        title += " " + formatShift(first);
      }
      out.push(`${title}（共 ${arr.length} 人）：`);
      arr.forEach(item=>{ out.push(`- ${item.name}`); });
      out.push("");
    });
    outputText3.value = out.join("\n");
    updateStatsBox(stats,stats3);
  }

  btnShiftPeople.onclick=()=>{
    try{
      const raw = inputRaw3.value;
      shiftPeopleData = parseShiftPeopleStructure(raw);
      dateSelect3.innerHTML='<option value="">请选择日期</option>';
      shiftPeopleData.blocks.forEach(b=>{
        const opt=document.createElement("option");
        opt.value=b.date;
        opt.textContent=b.date;
        dateSelect3.appendChild(opt);
      });
      if(shiftPeopleData.blocks.length===1){
        dateSelect3.value=shiftPeopleData.blocks[0].date;
        renderShiftPeopleForSelected();
      }else{
        outputText3.value="";
        stats3.innerHTML="";
      }
      setStatus3("解析完成，请从下拉选择日期","ok");
    }catch(e){
      shiftPeopleData=null;
      dateSelect3.innerHTML='<option value="">请选择日期</option>';
      outputText3.value=""; stats3.innerHTML="";
      setStatus3(e.message||"解析失败","error");
    }
  };

  dateSelect3.onchange = renderShiftPeopleForSelected;

  btnClear3.onclick=()=>{
    inputRaw3.value="";
    dateSelect3.innerHTML='<option value="">请选择日期</option>';
    outputText3.value=""; stats3.innerHTML="";
    shiftPeopleData=null;
    setStatus3("已清空","ok");
  };

  // ---------- 模式 4：按日期查代码 ----------
  const inputRaw4 = document.getElementById("inputRaw4");
  const daySelect4 = document.getElementById("daySelect4");
  const codeSelect4 = document.getElementById("codeSelect4");
  const btnParse4 = document.getElementById("btnParse4");
  const btnClear4 = document.getElementById("btnClear4");
  const btnQuery4 = document.getElementById("btnQuery4");
  const status4 = document.getElementById("status4");
  const outputText4 = document.getElementById("outputText4");
  let sheet4 = null;
  function setStatus4(t,type){if(!t){status4.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status4.innerHTML=`<span class="${c}">${t}</span>`;}

  btnParse4.onclick=()=>{
    try{
      const raw=inputRaw4.value;
      sheet4=parseFullSheet(raw);
      daySelect4.innerHTML='<option value="">请选择日期</option>';
      sheet4.days.forEach(d=>{
        const opt=document.createElement("option");
        opt.value=d.day;
        opt.textContent=d.label;
        daySelect4.appendChild(opt);
      });
      codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
      outputText4.value="";
      setStatus4("解析成功，请选择日期和代码","ok");
    }catch(e){
      sheet4=null;
      daySelect4.innerHTML='<option value="">请选择日期</option>';
      codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
      outputText4.value="";
      setStatus4(e.message||"解析失败","error");
    }
  };

  daySelect4.onchange=()=>{
    if(!sheet4){return;}
    const day=parseInt(daySelect4.value,10);
    if(!day){codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';return;}
    const set=new Set();
    sheet4.staffRows.forEach(r=>{
      const v=r.codes[day];
      if(!v) return;
      const t=v.trim();
      if(!t) return;
      if(!isCodeOrShiftToken(t)) return;
      set.add(t);
    });
    const list=Array.from(set).sort();
    codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
    list.forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c;
      opt.textContent=c;
      codeSelect4.appendChild(opt);
    });
  };

  btnQuery4.onclick=()=>{
    try{
      if(!sheet4) throw new Error("请先解析整页表格");
      const day=parseInt(daySelect4.value,10);
      const code=(codeSelect4.value||"").trim();
      if(!day) throw new Error("请选择日期");
      if(!code) throw new Error("请选择代码 / 班次");
      const names=[];
      sheet4.staffRows.forEach(r=>{
        const v=(r.codes[day]||"").trim();
        if(v.toUpperCase()===code.toUpperCase()) names.push(r.name);
      });
      const label=sheet4.dayToLabel[day] || `本月第${day}天`;
      let text=`${label} 代码 ${code} 对应人员（共 ${names.length} 人）：\n`;
      if(!names.length){
        text+="\n当前日期没有该代码。";
      }else{
        names.forEach(n=>{ text+=`\n- ${n}`; });
      }
      outputText4.value=text;
      setStatus4("查询完成","ok");
    }catch(e){
      outputText4.value="";
      setStatus4(e.message||"查询失败","error");
    }
  };

  btnClear4.onclick=()=>{
    inputRaw4.value="";
    sheet4=null;
    daySelect4.innerHTML='<option value="">请选择日期</option>';
    codeSelect4.innerHTML='<option value="">请选择代码 / 班次</option>';
    outputText4.value="";
    setStatus4("已清空","ok");
  };

  // ---------- 模式 5：整月代码统计 ----------
  const inputRaw5 = document.getElementById("inputRaw5");
  const codeInput5 = document.getElementById("codeInput5");
  const btnClear5 = document.getElementById("btnClear5");
  const btnStats5 = document.getElementById("btnStats5");
  const status5 = document.getElementById("status5");
  const outputText5 = document.getElementById("outputText5");
  function setStatus5(t,type){if(!t){status5.innerHTML="";return;}const c=type==="ok"?"ok":type==="error"?"error":"";status5.innerHTML=`<span class="${c}">${t}</span>`;}

  btnStats5.onclick=()=>{
    try{
      const raw=inputRaw5.value;
      const sheet=parseFullSheet(raw);
      const code=(codeInput5.value.trim()||"MC").toUpperCase();
      const countMap=new Map();
      sheet.staffRows.forEach(r=>{
        let cnt=0;
        sheet.days.forEach(d=>{
          const v=(r.codes[d.day]||"").trim().toUpperCase();
          if(v===code) cnt++;
        });
        if(cnt>0) countMap.set(r.name,cnt);
      });
      const list=Array.from(countMap.entries()).sort((a,b)=>{
        if(b[1]!==a[1]) return b[1]-a[1];
        return a[0].localeCompare(b[0]);
      });
      let total=0;
      list.forEach(([_,c])=>{ total+=c; });
      let text=`整个月代码 ${code} 统计：\n\n`;
      text+=`共有 ${list.length} 人出现过该代码，总次数 ${total} 次。\n\n`;
      if(!list.length){
        text+="当前表格中未找到该代码。";
      }else{
        list.forEach(([name,c])=>{
          text+=`- ${name}：${code} ${c} 次\n`;
        });
      }
      outputText5.value=text;
      setStatus5("统计完成","ok");
    }catch(e){
      outputText5.value="";
      setStatus5(e.message||"统计失败","error");
    }
  };

  btnClear5.onclick=()=>{
    inputRaw5.value="";
    codeInput5.value="";
    outputText5.value="";
    setStatus5("已清空","ok");
  };
</script>
</body>
</html>
